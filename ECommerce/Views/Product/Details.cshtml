@model ProductDetailsViewModel

@{
    var product = Model.Product;
    var relatedProducts = Model.RelatedProducts;
    var comments = product.Comments;
    var averageRating = comments.Any() ? comments.Average(c => c.Rating) : 0;
    var fullstars = (int)Math.Floor(averageRating);
    var halfstar = averageRating - fullstars >= 0.5;

}

@{/* Neden bunu ekledim, zaafiyet yaratır mı bilmiyorum sorucam! */}
<input type="hidden" id="productId" value="@product.Id" />

COOKŞİLERİ EKLE

<section class="product-details spad">
    <div class="container">
        <div class="row">
            <div class="col-lg-6 col-md-6">
                <div class="product__details__pic">
                    <div class="product__details__pic__item">
                        <img class="product__details__pic__item--large"
                             src="@product.ImageUrl" alt="@product.Name">
                    </div>
                    <div class="product__details__pic__slider owl-carousel">
                        <img data-imgbigurl="~/img/product/details/product-details-2.jpg"
                             src="~/img/product/details/thumb-1.jpg" alt="">
                        <img data-imgbigurl="~/img/product/details/product-details-3.jpg"
                             src="~/img/product/details/thumb-2.jpg" alt="">
                        <img data-imgbigurl="~/img/product/details/product-details-5.jpg"
                             src="~/img/product/details/thumb-3.jpg" alt="">
                        <img data-imgbigurl="~/img/product/details/product-details-4.jpg"
                             src="~/img/product/details/thumb-4.jpg" alt="">
                    </div>
                </div>
            </div>
            <div class="col-lg-6 col-md-6">
                <div class="product__details__text">
                    <h3>@product.Name</h3>
                    <div class="product__details__rating">
                        
                        @for (int i = 0; i < fullstars; i++)
                        {
                            <i class="fa fa-star"></i>
                        }

                        @if (halfstar)
                        {
                            <i class="fa fa-star-half-o"></i>
                        }
                        @for (int i = fullstars + (halfstar ? 1 : 0); i < 5; i++)
                        {
                            <i class="fa fa-star-o"></i>
                        }


                        <span>(@(comments.Any() ? comments.Count() : 0) reviews)</span>
                    </div>
                    <div class="product__details__price">$@product.Price</div>
                    <p>
                        @product.Description
                    </p>
                    <div class="product__details__quantity">
                        <div class="quantity">
                            <div class="pro-qty">
                                <input type="text" value="1">
                            </div>
                        </div>
                    </div>
                    <a href="#" class="primary-btn">ADD TO CARD</a>
                    <a href="#" class="heart-icon"><span class="icon_heart_alt"></span></a>
                    <ul>
                        <li><b>Availability</b> <span>In Stock</span></li>
                        <li><b>Shipping</b> <span>01 day shipping. <samp>Free pickup today</samp></span></li>
                        <li>
                            <b>Share on</b>
                            <div class="share">
                                <a href="#"><i class="fa fa-facebook"></i></a>
                                <a href="#"><i class="fa fa-twitter"></i></a>
                                <a href="#"><i class="fa fa-instagram"></i></a>
                                <a href="#"><i class="fa fa-pinterest"></i></a>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="col-lg-12">
                <div class="product__details__tab">
                    <ul class="nav nav-tabs" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" data-toggle="tab" href="#tabs-1" role="tab"
                               aria-selected="true">Description</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="reviews-tab" data-toggle="tab" href="#tabs-2" role="tab"
                               aria-selected="false">Reviews <span>@(comments.Any() ? comments.Count() : 0)</span></a>
                        </li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane active" id="tabs-1" role="tabpanel">
                            <div class="product__details__tab__desc">
                                <h6>Products Description</h6>
                                <p>
                                    @product.Description
                                </p>
                            </div>
                        </div>
                        <div class="tab-pane" id="tabs-2" role="tabpanel">
                            <div class="product__details__tab__desc">
                                <div class="product__details__tab__desc" id="commentsContainer">
                                    Click on tab to load reviews...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<!-- Product Details Section End -->
<!-- Related Product Section Begin -->
<section class="related-product">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <div class="section-title related__product__title">
                    <h2>Related Product</h2>
                </div>
            </div>
        </div>
        <div class="row">
            

            @foreach(var rp in relatedProducts)
            {
                <div class="col-lg-3 col-md-4 col-sm-6">
                    <div class="product__item">
                        <div class="product__item__pic set-bg" data-setbg="@rp.ImageUrl">
                            <ul class="product__item__pic__hover">
                                <li><a href="#"><i class="fa fa-heart"></i></a></li>
                                <li><a href="#"><i class="fa fa-retweet"></i></a></li>
                                <li><a href="#"><i class="fa fa-shopping-cart"></i></a></li>
                            </ul>
                        </div>
                        <div class="product__item__text">
                            <h6><a href="#">@rp.Name</a></h6>
                            <h5>$@rp.Price</h5>
                        </div>
                    </div>
                </div>
            }

        </div>
    </div>
</section>
<!-- Related Product Section End -->




@section scripts{


    <script>

        let loadedComments = false;
        const reviewsTab = document.getElementById("reviews-tab");
        const commentsContainer =  document.getElementById("commentsContainer");
        const productId = document.getElementById("productId");
        const productIdValue = productId.value;


        reviewsTab.addEventListener("click", async () => {

            if (loadedComments) return;

            const baseUrl = "/Comment/GetCommentsJSON";
            const url = `${baseUrl}?$ProductId=${productIdValue}`;
            console.log(url);

            const response = await fetch(url);
            const data = response.data;
            const comments = await response.data;

            commentsContainer.innerHTML = "";

            comments.forEach(comments => {
                
                const div = document.createElement("div");
                    div.innerHTML = `
                        <strong>${comment.userName}</strong> - ${comment.rating} ⭐<br>
                        <p>${comment.text}</p>
                        <small>${new Date(comment.createdAt).toLocaleString()}</small>
                        <hr/>
                    `;
                commentsContainer.appendChild(div);
            })

            loadedComments = true;

        });




    </script>



}
