@model ProductDetailsViewModel

@{
    var product = Model.Product;
    var relatedProducts = Model.RelatedProducts;
    var comments = product.Comments;
    var averageRating = comments.Any() ? comments.Average(c => c.Rating) : 0;
    var fullstars = (int)Math.Floor(averageRating);
    var halfstar = averageRating - fullstars >= 0.5;

}

@{/* Neden bunu ekledim, zaafiyet yaratır mı bilmiyorum sorucam! */}
<input type="hidden" id="productId" value="@product.Id" />


<section class="product-details spad">
    <div class="container">
        <div class="row">
            <div class="col-lg-6 col-md-6">
                <div class="product__details__pic">
                    <div class="product__details__pic__item">
                        <img class="product__details__pic__item--large"
                             src="@product.ImageUrl" alt="@product.Name">
                    </div>                    
                </div>
            </div>
            <div class="col-lg-6 col-md-6">
                <div class="product__details__text">
                    <h3>@product.Name</h3>
                    <div class="product__details__rating">
                        
                        @for (int i = 0; i < fullstars; i++)
                        {
                            <i class="fa fa-star"></i>
                        }

                        @if (halfstar)
                        {
                            <i class="fa fa-star-half-o"></i>
                        }
                        @for (int i = fullstars + (halfstar ? 1 : 0); i < 5; i++)
                        {
                            <i class="fa fa-star-o"></i>
                        }


                        <span>(@(comments.Any() ? comments.Count() : 0) değerlendirme)</span>
                    </div>
                    <div class="product__details__price">@product.Price TL</div>
                    <p>
                        @product.Description
                    </p>
                    <div class="product__details__quantity">
                        <div class="quantity">
                            <div class="pro-qty">
                                <input id="item-quantity-input" type="text" value="1">
                            </div>
                        </div>
                    </div>
                    <a href="#" class="primary-btn add-to-cart-btn">SEPETE EKLE</a>
                    <a href="#" class="heart-icon"><span class="icon_heart_alt"></span></a>
                    <ul>
                        <li><b>Availability</b> <span>Stokta</span></li>
                        <li>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="col-lg-12">
                <div class="product__details__tab">
                    <ul class="nav nav-tabs" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" data-toggle="tab" href="#tabs-1" role="tab"
                               aria-selected="true">Description</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="reviews-tab" data-toggle="tab" href="#tabs-2" role="tab"
                               aria-selected="false">Reviews <span>@(comments.Any() ? comments.Count() : 0)</span></a>
                        </li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane active" id="tabs-1" role="tabpanel">
                            <div class="product__details__tab__desc">
                                <h6>Ürün Açıklaması</h6>
                                <p>
                                    @product.Description
                                </p>
                            </div>
                        </div>
                        <div class="tab-pane" id="tabs-2" role="tabpanel">
                            <div class="product__details__tab__desc">
                                <div class="product__details__tab__desc" id="commentsContainer">
                                    Yorumları yüklemek için tıklayın...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<!-- Product Details Section End -->
<!-- Related Product Section Begin -->
<section class="related-product">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <div class="section-title related__product__title">
                    <h2>Benzer Ürünler</h2>
                </div>
            </div>
        </div>
        <div class="row">
            

            @foreach(var rp in relatedProducts)
            {
                <div class="col-lg-3 col-md-4 col-sm-6">
                    <div class="product__item">
                        <div class="product__item__pic set-bg" data-setbg="@rp.ImageUrl">
                            <input class="product-id" type="hidden" value="@rp.Id" />
                            <ul class="product__item__pic__hover">
                                <li><a href="#"><i class="fa fa-heart"></i></a></li>
                                <li><a href="#"><i class="fa fa-retweet"></i></a></li>
                                <li><a class="add-to-cart-btn" href="#"><i class="fa fa-shopping-cart"></i></a></li>
                            </ul>
                        </div>
                        <div class="product__item__text">
                            <h6><a href="#">@rp.Name</a></h6>
                            <h5>@rp.Price TL</h5>
                        </div>
                    </div>
                </div>
            }

        </div>
    </div>
</section>
<!-- Related Product Section End -->




@section scripts{


    <script>

        let loadedComments = false;
        const reviewsTab = document.getElementById("reviews-tab");
        const commentsContainer =  document.getElementById("commentsContainer");
        const productId = document.getElementById("productId");
        const productIdValue = productId.value;


        reviewsTab.addEventListener("click", async () => {

            if (loadedComments) return;

            const baseUrl = "/Comment/GetCommentsJSON";
            const url = `${baseUrl}?$ProductId=${productIdValue}`;
            console.log(url);

            const response = await fetch(url);
            const data = response.data;
            const comments = await response.data;

            commentsContainer.innerHTML = "";

            comments.forEach(comments => {
                
                const div = document.createElement("div");
                    div.innerHTML = `
                        <strong>${comment.userName}</strong> - ${comment.rating} ⭐<br>
                        <p>${comment.text}</p>
                        <small>${new Date(comment.createdAt).toLocaleString()}</small>
                        <hr/>
                    `;
                commentsContainer.appendChild(div);
            })

            loadedComments = true;

        });


        /////////// SEPETE ÜRÜN EKLEME ////////////////////////////

        document.addEventListener("click", function(event){

                const button = event.target.closest(".add-to-cart-btn");
                if (!button) return;

                event.preventDefault();

                let productId;
                let quantity = 1;

                const productItem = button.closest(".product__item");
                if (productItem){
                    productId = productItem.querySelector(".product-id").value;
                }
                else{
                    productId = document.getElementById("productId").value;
                    quantity = document.getElementById("item-quantity-input").value;

                }



                console.log("Sepete eklendi ", productId);



                fetch("/Cart/AddItemToCart", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ ProductId: productId , Quantity: quantity})
                    })
                .then(res => res.json())
                .then(data => {
                    if(data.message){
                        Swal.fire({
                            title: "Başarılı!",
                            text: data.message,
                            icon: "success",
                            timer: 1500,
                            showConfirmButton: false
                        });
                    }
                    window.updateCartDiv();

                })
                .catch(err => {
                    console.error(err);
                    Swal.fire({
                        title: "Hata!",
                        text: "Ürün eklenemedi",
                        icon: "error"
                    });
                });





            });


        const productDivs = document.querySelectorAll(".product__item__pic");
            productDivs.forEach(pic =>{

                    pic.addEventListener("click",function(event){

                        const featuredItem = event.target.closest(".product__item");
                        const productId = featuredItem.querySelector(".product-id").value;

                        window.location.href = `/Product/Details/${productId}`

                    });

            });



    </script>



}
