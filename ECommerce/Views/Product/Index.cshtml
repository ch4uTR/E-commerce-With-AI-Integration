@model List<ProductViewModel>


@{
    int totalCount = ViewBag.TotalCount;
    int currentPage = ViewBag.CurrentPage;
    int pageSize = ViewBag.PageSize;
    int totalPages = (int)Math.Ceiling((double)totalCount / pageSize);
    int? selectedCategoryId = ViewBag.SelectedCategoryId;
}


<section class="product spad">
    <div class="container">
        <div class="row">
            <div class="col-lg-3 col-md-5">
                <div class="sidebar">
                    <div class="sidebar__item">
                        <h4>Kategoriler</h4>


                        <ul id="sidebar-category-ul">
                            @await Component.InvokeAsync("CategoryList", selectedCategoryId)
                        </ul>

                    </div>
                    <div class="sidebar__item">
                        <h4>Fiyat</h4>
                        <div class="price-range-wrap">
                            <div class="price-range ui-slider ui-corner-all ui-slider-horizontal ui-widget ui-widget-content"
                                 data-min="10" data-max="540">
                                <div class="ui-slider-range ui-corner-all ui-widget-header"></div>
                                <span tabindex="0" class="ui-slider-handle ui-corner-all ui-state-default"></span>
                                <span tabindex="0" class="ui-slider-handle ui-corner-all ui-state-default"></span>
                            </div>
                            <div class="range-slider">
                                <div class="price-input">
                                    <input type="text" id="minamount">
                                    <input type="text" id="maxamount">
                                </div>
                            </div>
                        </div>
                    </div>                                      
                    <div class="sidebar__item">
                        <div class="latest-product__text">
                            <h4>Latest Products</h4>
                            <div class="latest-product__slider owl-carousel">
                                <div class="latest-prdouct__slider__item">
                                    <a href="#" class="latest-product__item">
                                        <div class="latest-product__item__pic">
                                            <img src="img/latest-product/lp-1.jpg" alt="">
                                        </div>
                                        <div class="latest-product__item__text">
                                            <h6>Crab Pool Security</h6>
                                            <span>$30.00</span>
                                        </div>
                                    </a>
                                    <a href="#" class="latest-product__item">
                                        <div class="latest-product__item__pic">
                                            <img src="img/latest-product/lp-2.jpg" alt="">
                                        </div>
                                        <div class="latest-product__item__text">
                                            <h6>Crab Pool Security</h6>
                                            <span>$30.00</span>
                                        </div>
                                    </a>
                                    <a href="#" class="latest-product__item">
                                        <div class="latest-product__item__pic">
                                            <img src="img/latest-product/lp-3.jpg" alt="">
                                        </div>
                                        <div class="latest-product__item__text">
                                            <h6>Crab Pool Security</h6>
                                            <span>$30.00</span>
                                        </div>
                                    </a>
                                </div>
                                <div class="latest-prdouct__slider__item">
                                    <a href="#" class="latest-product__item">
                                        <div class="latest-product__item__pic">
                                            <img src="img/latest-product/lp-1.jpg" alt="">
                                        </div>
                                        <div class="latest-product__item__text">
                                            <h6>Crab Pool Security</h6>
                                            <span>$30.00</span>
                                        </div>
                                    </a>
                                    <a href="#" class="latest-product__item">
                                        <div class="latest-product__item__pic">
                                            <img src="img/latest-product/lp-2.jpg" alt="">
                                        </div>
                                        <div class="latest-product__item__text">
                                            <h6>Crab Pool Security</h6>
                                            <span>$30.00</span>
                                        </div>
                                    </a>
                                    <a href="#" class="latest-product__item">
                                        <div class="latest-product__item__pic">
                                            <img src="img/latest-product/lp-3.jpg" alt="">
                                        </div>
                                        <div class="latest-product__item__text">
                                            <h6>Crab Pool Security</h6>
                                            <span>$30.00</span>
                                        </div>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-9 col-md-7">
                <div class="filter__item">
                    <div class="row">
                        <div class="col-lg-4 col-md-5">
                            <div class="filter__sort">
                                <span>Sort By</span>
                                <select id="sort-select">
                                    <option value="default">Default</option>
                                    <option value="priceasc">Price: Low to High</option>
                                    <option value="pricedesc">Price: High to Low</option>
                                    <option value="totalsolddesc">Total Sold: High to Low</option>
                                    <option value="totalsoldasc">Total Sold: High to Low</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-lg-4 col-md-4">
                            <div class="filter__found">
                                <h6><span id="product-count"></span> @Model.Count() /@totalCount Products listed</h6>
                            </div>
                        </div>
                        <div class="col-lg-4 col-md-3">
                            <div class="filter__option">
                                <span class="icon_grid-2x2"></span>
                                <span class="icon_ul"></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="product-row" class="row">
                    

                    @foreach(var product in Model)
                    {
                        <div class="col-lg-4 col-md-6 col-sm-6">
                            <div class="product__item">
                                <div class="product__item__pic set-bg" data-setbg="@product.ImageUrl">
                                    <ul class="product__item__pic__hover">
                                        <input type="hidden" class="product-id" value="@product.Id"/>
                                        <li><a ><i class="fa fa-heart"></i></a></li>
                                        <li><a href="#"><i class="fa fa-retweet"></i></a></li>
                                        <li><a href="#" class="add-to-cart-btn"><i class="fa fa-shopping-cart"></i></a></li>
                                    </ul>
                                </div>
                                <div class="product__item__text">
                                    <h6><a asp-area="" asp-controller="Product" asp-action="Details" asp-route-id="@product.Id">@product.ProductName</a></h6>
                                    <h5>@product.Price TL</h5>
                                </div>
                            </div>
                        </div>
                    }             
                </div>
                <div class="product__pagination">
                    <a href="#">1</a>
                    <a href="#">2</a>
                    <a href="#">3</a>
                    <a href="#"><i class="fa fa-long-arrow-right"></i></a>
                </div>
            </div>
        </div>
    </div>
</section>
<!-- Product Section End -->


<style>

    ul li.active > a {
        color: #7fad39;
        font-weight: bold;
    }

</style>



@section Scripts{


    <script>
        

        /////////////////////////////------------SAYFA YÜKLENDİĞİNDE YAPILACAK İŞLEMLER-------////////////////////////////
        document.addEventListener("DOMContentLoaded", function(){


            ///// SIRALAMA İŞLEMİ //////////////////////////////////

                const filter = {
                        SearchTerm : null,
                        MinPrice : null,
                        MaxPrice : null,
                        CategoryId : null,
                        Page : null,
                        Size : null,
                        SortBy : null
                    };

                //parametreleri aldım
                const sortMenu = document.getElementById("sort-select");
                sortMenu.style.display = "";

                sortMenu.addEventListener("change", function(event){

                const urlParams = new URLSearchParams(window.location.search);
                

                    urlParams.forEach((value,key) =>{
                        if (filter.hasOwnProperty(key)){
                            filter[key] = value;
                        }
                    });
                    //sortby ı değiştireyim//
                    filter["SortBy"] = event.target.value;

                    //filterdaki nulların olmadığı ImageBitmapRenderingContext dict oluşturmalı

                    const cleanFilter = {};
                    for (const key in filter) {
                        if (filter[key] !== null && filter[key] !== undefined && filter[key] !== "") {
                            cleanFilter[key] = filter[key];
                        }
                    }

                    console.log(cleanFilter);
  

                    //fetch File verileri alıcam

                    const baseUrl = "/Product/GetProductsJSON";
                    const queryParams = new URLSearchParams(cleanFilter).toString();
                    const productRow = document.getElementById("product-row");

                    console.log(queryParams);

                    fetch(`${baseUrl}?${queryParams}`)
                        .then(res => res.json())
                        .then(data => {

                            productRow.innerHTML = ``;
                            console.log(data);
                            data.data.forEach(item => {
                                const newRow = `
                                <div class="col-lg-4 col-md-6 col-sm-6">
                                    <div class="product__item">
                                        <div class="product__item__pic set-bg" data-setbg="${item.ImageUrl}">
                                            <ul class="product__item__pic__hover">
                                                <input type="hidden" class="product-id" value="${item.Id}"/>
                                                <li><a ><i class="fa fa-heart"></i></a></li>
                                                <li><a href="#"><i class="fa fa-retweet"></i></a></li>
                                                <li><a href="#" class="add-to-cart-btn"><i class="fa fa-shopping-cart"></i></a></li>
                                            </ul>
                                        </div>
                                        <div class="product__item__text">
                                            <h6><a asp-area="" asp-controller="Product" asp-action="Details" asp-route-id="${item.Id}">${item.ProductName}</a></h6>
                                            <h5>${item.Price} TL</h5>
                                        </div>
                                    </div>
                                </div>

                                `;

                                 productRow.innerHTML += newRow;
                            });

                    });


            });

            



        });
            ////////////////////////////// Resme tıklanınca ürüün detay sayfasına gitme //////////////////

            const productDivs = document.querySelectorAll(".product__item__pic");
            productDivs.forEach(pic =>{

                    pic.addEventListener("click",function(event){

                        const featuredItem = event.target.closest(".product__item");
                        const productId = featuredItem.querySelector(".product-id").value;

                        window.location.href = `/Product/Details/${productId}`

                    });

            });


            //////////////       SEPETE ÜRÜN EKLEME /////////////////

            document.addEventListener("click", function(event){

                const button = event.target.closest(".add-to-cart-btn");
                if (!button) return;

                event.preventDefault();

                const productItem = button.closest(".product__item");
                const productId = productItem.querySelector(".product-id").value;


                console.log("Sepete eklendi ", productId);



                fetch("/Cart/AddItemToCart", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ ProductId: productId })
                    })
                .then(res => res.json())
                .then(data => {
                    if(data.message){
                        Swal.fire({
                            title: "Başarılı!",
                            text: data.message,
                            icon: "success",
                            timer: 1500,
                            showConfirmButton: false
                        });
                    }
                    window.updateCartDiv();

                })
                .catch(err => {
                    console.error(err);
                    Swal.fire({
                        title: "Hata!",
                        text: "Ürün eklenemedi",
                        icon: "error"
                    });
                });


                    


            });



            ////////////// /////////////////////////////////////////////




   

            
           
           



        
    </script>



}